(()=>{var l=(n,p,c)=>new Promise((o,s)=>{var i=t=>{try{e(c.next(t))}catch(r){s(r)}},a=t=>{try{e(c.throw(t))}catch(r){s(r)}},e=t=>t.done?o(t.value):Promise.resolve(t.value).then(i,a);e((c=c.apply(n,p)).next())});var u=()=>{apos.define("page-scan-modal",{extend:"apostrophe-modal",source:"page-scan-modal",construct:(n,p)=>{let c=n.beforeShow;n.beforeShow=o=>{n.$deadLinks=n.$el.find(".dead-links"),n.$el.on("click","[data-apos-scan-dead-links]",function(){n.scanDeadLinks()}),c(o)},n.scanDeadLinks=()=>l(void 0,null,function*(){let s=$("body").find("a").not(".apos-ui a");n.startScanning();let i=n.splitLinks(s),{deadLinks:a,corsError:e}=yield n.checkInternalLinks(i.internal);n.injectDeadLinks(a,"internal",e);let t=yield n.checkExternalLinks(i.external);n.injectDeadLinks(t,"external"),n.$deadLinks.removeClass("loading")}),n.startScanning=()=>{n.$deadLinks.find(".dead-links-results p").remove(),n.$deadLinks.find(".dead-links-results ul").empty(),n.$deadLinks.addClass("loading")},n.splitLinks=o=>{let{origin:s,host:i}=window.location,a=[],e=[];return o.each(function(t,r){let d=$(r).attr("href");d&&((d.startsWith("/")?s+d:d).includes(i)?a.push(d):e.push(d))}),{internal:a,external:e}},n.checkInternalLinks=o=>l(void 0,null,function*(){let s=[],i=!1;for(let a of o)try{let e=yield n.requestHead(a);e&&s.push(e)}catch(e){e.status===0&&(i=!0)}return{deadLinks:s,corsError:i}}),n.requestHead=o=>new Promise((s,i)=>{$.ajax(o,{method:"HEAD",error:a=>{i(a)}}).done((a,e,t)=>{s(t.status===404&&o)})}),n.checkExternalLinks=o=>l(void 0,null,function*(){let s=10,i=[];return yield a(o),i;function a(e){return l(this,null,function*(){try{let t=e.splice(0,s);if(!t.length)return;let r=yield apos.utils.post(`${n.action}/check-dead-links`,{links:t});r&&r.forEach(d=>{i.push(d)})}catch(t){}yield a(e)})}}),n.injectDeadLinks=(o,s,i)=>{let a=s==="internal"?n.$el.find(".dead-links-results__internal"):n.$el.find(".dead-links-results__external"),e=a.find("ul");o.length?(a.prepend(`<p class="data-seo-page-scan-modal__result error"> There are some ${s} dead links:</p>`),o.forEach(t=>{e.append(`<li><a href="${t}">${t}</a></li>`)})):(a.prepend(`<p class="data-seo-page-scan-modal__result"> There are no ${s} dead links</p>`),i&&a.prepend('<p class="data-seo-page-scan-modal__result error">Warning: you could have some CORS issues</p>'))}}})};u();apos.define("apostrophe-seo",{extend:"apostrophe-context",construct:(n,p)=>{n.scan=()=>apos.create("page-scan-modal",{action:n.action,body:{href:window.location.href}})}});})();
